name: Betadash è‡ªåŠ¨ç™»å½•

on:
  # 1. æ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼ˆå¯é€‰ï¼‰
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆæ˜¾ç¤ºæµè§ˆå™¨ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  
  # 2. å®šæ—¶è§¦å‘ï¼ˆä¾‹å¦‚æ¯å¤© UTC æ—¶é—´ 00:00 è¿è¡Œï¼Œå³åŒ—äº¬æ—¶é—´ 08:00ï¼‰
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC åˆå¤œè¿è¡Œ
  
  # 3. ä»£ç æ¨é€æ—¶è§¦å‘ï¼ˆå¯é€‰ï¼Œç”¨äºæµ‹è¯•ï¼‰
  push:
    branches: [ main, master ]
    paths:
      - 'login.js'
      - '.github/workflows/**'

# 4. é˜²æ­¢å¹¶å‘è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  automated-login:
    name: æ‰§è¡Œè‡ªåŠ¨ç™»å½•
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: ğŸ›ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # æ­¥éª¤ 2: è®¾ç½® Node.js ç¯å¢ƒ
      - name: â” è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'  # Puppeteer å…¼å®¹çš„ç‰ˆæœ¬
          cache: 'npm'
      
      # æ­¥éª¤ 3: å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆPuppeteer æ‰€éœ€ï¼‰
      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ca-certificates \
            fonts-liberation \
            libappindicator3-1 \
            libasound2 \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libc6 \
            libcairo2 \
            libcups2 \
            libdbus-1-3 \
            libexpat1 \
            libfontconfig1 \
            libgbm1 \
            libgcc1 \
            libglib2.0-0 \
            libgtk-3-0 \
            libnspr4 \
            libnss3 \
            libpango-1.0-0 \
            libpangocairo-1.0-0 \
            libstdc++6 \
            libx11-6 \
            libx11-xcb1 \
            libxcb1 \
            libxcomposite1 \
            libxcursor1 \
            libxdamage1 \
            libxext6 \
            libxfixes3 \
            libxi6 \
            libxrandr2 \
            libxrender1 \
            libxss1 \
            libxtst6 \
            lsb-release \
            wget \
            xdg-utils
      
      # æ­¥éª¤ 4: å®‰è£… Node.js ä¾èµ–
      - name: ğŸ“¥ å®‰è£…é¡¹ç›®ä¾èµ–
        run: |
          # åˆ›å»º package.json å¦‚æœä¸å­˜åœ¨
          if [ ! -f "package.json" ]; then
            echo '{
              "name": "betadash-auto-login",
              "version": "1.0.0",
              "dependencies": {
                "puppeteer": "^21.0.0",
                "axios": "^1.6.0",
                "dotenv": "^16.3.0"
              }
            }' > package.json
          fi
          
          npm ci --no-audit --no-fund
          # æˆ–è€…å¦‚æœä¸Šé¢å¤±è´¥ï¼Œä½¿ç”¨ npm install
          # npm install --no-audit --no-fund
      
      # æ­¥éª¤ 5: é…ç½®ç¯å¢ƒå˜é‡
      - name: âš™ï¸ é…ç½®ç¯å¢ƒ
        run: |
          # ä» GitHub Secrets åˆ›å»º .env æ–‡ä»¶
          cat > .env << EOF
          WEBSITE_URL=${{ secrets.WEBSITE_URL }}
          USERNAME=${{ secrets.USERNAME }}
          PASSWORD=${{ secrets.PASSWORD }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          HEADLESS=${{ github.event.inputs.debug_mode == 'true' && 'false' || 'true' }}
          EOF
          
          # æ˜¾ç¤ºé…ç½®ä¿¡æ¯ï¼ˆéšè—æ•æ„Ÿæ•°æ®ï¼‰
          echo "âœ… ç¯å¢ƒå˜é‡å·²é…ç½®"
          echo "ğŸŒ ç½‘ç«™: $(echo ${{ secrets.WEBSITE_URL }} | sed 's|https://||')"
          echo "ğŸ‘¤ ç”¨æˆ·: $(echo ${{ secrets.USERNAME }} | sed 's/./*/g')"
          echo "ğŸ¤– Telegram Bot: $(echo ${{ secrets.TELEGRAM_BOT_TOKEN }} | cut -d':' -f1 | sed 's/./*/g')"
          echo "ğŸ“± Telegram Chat: ${{ secrets.TELEGRAM_CHAT_ID }}"
          echo "ğŸ–¥ï¸  æ— å¤´æ¨¡å¼: ${{ github.event.inputs.debug_mode == 'true' && 'false' || 'true' }}"
      
      # æ­¥éª¤ 6: è¿è¡Œç™»å½•è„šæœ¬
      - name: ğŸš€ æ‰§è¡Œè‡ªåŠ¨ç™»å½•
        id: run-login
        timeout-minutes: 10  # è®¾ç½®è¶…æ—¶é˜²æ­¢å¡ä½
        run: |
          echo "å¼€å§‹æ‰§è¡Œç™»å½•è„šæœ¬..."
          
          # è®¾ç½®æ›´é•¿çš„è¶…æ—¶ç¯å¢ƒå˜é‡
          export NODE_OPTIONS="--max-old-space-size=4096"
          
          # è¿è¡Œè„šæœ¬å¹¶æ•è·é€€å‡ºç 
          node login.js
          EXIT_CODE=$?
          
          echo "è„šæœ¬é€€å‡ºç : $EXIT_CODE"
          
          # ä¿å­˜é€€å‡ºçŠ¶æ€ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "login_exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… ç™»å½•è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ ç™»å½•è„šæœ¬æ‰§è¡Œå¤±è´¥"
            exit $EXIT_CODE
          fi
      
      # æ­¥éª¤ 7: ä¸Šä¼ æ—¥å¿—å’Œæˆªå›¾ï¼ˆä»…å¤±è´¥æ—¶ï¼‰
      - name: ğŸ“¤ ä¸Šä¼ æ‰§è¡Œç»“æœ
        if: failure() || steps.run-login.outputs.login_exit_code != '0'
        uses: actions/upload-artifact@v4
        with:
          name: login-debug-artifacts
          path: |
            *.png
            *.log
          retention-days: 7
      
      # æ­¥éª¤ 8: æ¸…ç†å·¥ä½œç©ºé—´
      - name: ğŸ§¹ æ¸…ç†å·¥ä½œç©ºé—´
        if: always()
        run: |
          echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -f *.png 2>/dev/null || true
          rm -f .env 2>/dev/null || true
          echo "âœ… æ¸…ç†å®Œæˆ"

      # æ­¥éª¤ 9: å‘é€æ‰§è¡Œæ€»ç»“åˆ° Telegramï¼ˆå¯é€‰ï¼‰
      - name: ğŸ“¨ å‘é€æ‰§è¡Œæ€»ç»“
        if: always()
        run: |
          WORKFLOW_URL="https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          STATUS="${{ job.status }}"
          
          # æ ¹æ®çŠ¶æ€ç”Ÿæˆæ¶ˆæ¯
          if [ "$STATUS" = "success" ]; then
            EMOJI="âœ…"
            STATUS_TEXT="æˆåŠŸ"
          else
            EMOJI="âŒ"
            STATUS_TEXT="å¤±è´¥"
          fi
          
          # æ„å»ºæ¶ˆæ¯
          MESSAGE="*${EMOJI} GitHub Actions æ‰§è¡Œå®Œæˆ*\n\n"
          MESSAGE+="ğŸ“… æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')\n"
          MESSAGE+="ğŸ“¦ ä»“åº“: $GITHUB_REPOSITORY\n"
          MESSAGE+="ğŸ“ å·¥ä½œæµ: $GITHUB_WORKFLOW\n"
          MESSAGE+="ğŸ“Š çŠ¶æ€: ${STATUS_TEXT}\n"
          MESSAGE+="ğŸ”— è¯¦æƒ…: $WORKFLOW_URL\n"
          
          # å¦‚æœæœ‰é”™è¯¯ï¼ŒåŒ…å«æ›´å¤šä¿¡æ¯
          if [ "$STATUS" != "success" ]; then
            MESSAGE+="\nâš ï¸ è¯·æŸ¥çœ‹ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚"
          fi
          
          # å‘é€åˆ° Telegram
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown" \
            -d "disable_web_page_preview=true"